#!/bin/bash

# vérification et récupération des arguments (<servername> <IP address>)
if [ -z $1 ];then
  echo
  read -p "Nom du serveur : " host
else
  host=$1
fi

if [ -z $2 ]; then
  echo
  read -p "Adresse IP : " IP
else
  IP=$2
fi

# Inscription de l'IP dans le script de post-install
sed -i "s/IP='.*'/IP='$IP'/" postinstall.sh

# création de l'instance avec association à Ext-Net
nova boot --key-name Desktop \
          --image "Ubuntu 16.04" \
          --flavor vps-ssd-1 \
          --nic net-id=8d3e91fd-c533-418f-8678-4252de201489 \
          --user-data postinstall.sh \
          --poll $host

# association à VLAN10
nova interface-attach --net-id 8ed23bf0-3ad3-4c29-9485-a821869d9ad4 --fixed-ip $IP $host

# récupération IP publique
pubIP=$(nova list | grep $host | grep -o "Ext-Net.*;" | grep -o "[0-9]*\.[0-9]*\.[0-9]*\.[0-9]*")

# mise à jour du fichier /etc/hosts
echo
echo "Mise à jour de /etc/hosts : "
echo

cat /etc/hosts | grep -v "$host.secretbox.cloud" | sudo tee /etc/hosts
echo "$pubIP		$host.secretbox.cloud		$host" | sudo tee -a /etc/hosts

echo "En attente redémarrage serveur."
sleep 15
echo "Demande de redémarrage hard du serveur."
nova reboot --hard --poll $host

echo
exit 0

